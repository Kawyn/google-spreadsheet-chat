<!DOCTYPE html>
<html>

  <head>
  
    <!-- METAMFETAMINA... -->
    <meta name="google-signin-client_id" content="911501730838-bs4m99gglnc6568ds4teu3pl2g6mi63v.apps.googleusercontent.com">
    <meta charset="utf-8" />
    
    <!-- LINA DO CSKA -->
    <link href="main.css" rel="stylesheet" type="text/css">


    <!-- TYTULIK <3 -->
    <title>Google Spreadsheets Chat</title>
  </head>
  <body>

    <!-- LOGIN WINDOW -->
    <div id="login_background">
     
      <div id="login_window"> 
     
        <input id="name_field" type="text" name="name" value="Anonymus">
        <img id="authorize_button"> 
      </div>
    </div>



    <!-- LEFT -->
    <div class="left_bar">

      <!-- NAZWY POKOI -->
      <div class="room_name"> <h3 id="room_name">Room #1</h3> </div>
      

      <!-- LISTA POKOI -->
      <div class="room_list"> 

        <h4 onclick="ChangeRoom(1);"> Room #1 </h4>  
        <h4 onclick="ChangeRoom(2);"> Room #2 </h4> 
        <h4 onclick="ChangeRoom(3);"> Room #3 </h4> 
        <h4 onclick="ChangeRoom(4);"> Room #4 </h4> 
      </div>
    </div>

    <!-- CHAT -->
    <div id="chat_main">

      <!-- DIV NA TEKST -->
      <div id="chat_text"> </div>
      

      <!-- WYSYŁANKO -->
      <textarea id="message_field" type="text" name="name"></textarea>
      <button id="send_button" onclick="Send();">Send</button>
    </div>
  


    <!-- SCRIPTS, SCRIPTOS, SCRIPTINTOS??? -->
    <pre id="content" style="white-space: pre-wrap;"> </pre>
    <script src="https://apis.google.com/js/platform.js" async defer> </script>
    <script type="text/javascript">
         
      //#region I copped it from Goole Website and I don't know what is happening here >:L
      
        // Client ID and API key from the Developer Console
        var CLIENT_ID = '911501730838-bs4m99gglnc6568ds4teu3pl2g6mi63v.apps.googleusercontent.com';
        var API_KEY = 'AIzaSyAKTVIb-0x3YM-5WomvHfgbndtVeRDUYQE';

        // Array of API discovery doc URLs for APIs used by the quickstart
        var DISCOVERY_DOCS = ["https://sheets.googleapis.com/$discovery/rest?version=v4"];

        // Authorization scopes required by the API; multiple scopes can be
        // included, separated by spaces.
        var SCOPES = "https://www.googleapis.com/auth/spreadsheets";

        // Authorize button...
        var authorizeButton = document.getElementById('authorize_button');


        // Load liblary...
        function handleClientLoad() 
      {
      
        gapi.load('client:auth2', initClient);
      }

        // Set up sign in state...
        function initClient() 
        {
          
          gapi.client.init({apiKey: API_KEY, clientId: CLIENT_ID, discoveryDocs: DISCOVERY_DOCS, scope: SCOPES}).then(function () 
          {
           
            // Listen for sign-in state changes.
            gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);

            // Handle the initial sign-in state.
            updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
            authorizeButton.onclick = handleAuthClick;
          }, 
          
        function(error){});
      }



        // Sign In things...
        function updateSigninStatus(isSignedIn) 
        {
          
          if (isSignedIn)   
          {
  
            authorizeButton.style.display = 'none';
            document.getElementById("login_background").style.display = 'none';

            Start();
          }
          else
          {
          
            authorizeButton.style.display = 'block';
            document.getElementById("login_background").style.display = 'block';
          }
        }
        function handleAuthClick(event) 
        {
          
          gapi.auth2.getAuthInstance().signIn();
        }
      //#endregion


      // Room ID...  
      var roomID = 1;
      
      
      // Start Chat...
      function Start()
      {

        gapi.client.sheets.spreadsheets.values.get({spreadsheetId: '1CcAqJT0d1mPRO5NoKcYT-30nfDYJkZYhUrtE0fm5vF4', range: roomID + '!A1:C',}).then(function(response)
        {
          
          // New message index...
          var index = response.result.values.length + 1;


          var values = [[ Time() , document.getElementById("name_field").value, "*wchodzi*"],];
          var body = {values: values};

          // Send new...
          gapi.client.sheets.spreadsheets.values.update({spreadsheetId: '1CcAqJT0d1mPRO5NoKcYT-30nfDYJkZYhUrtE0fm5vF4', range: roomID + '!A' + index + ':C', valueInputOption: 'RAW', resource: body}).then((response) => {var result = response.result;});
        }, 
        function(response) {});
 
        // Start Uptade...
        Update();
       }

      // Like in UNITY 3D <3
      function Update() 
      {
        
        gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: '1CcAqJT0d1mPRO5NoKcYT-30nfDYJkZYhUrtE0fm5vF4', range: roomID + '!A2:C',}).then(function(response) 
        {
        
          // Get all messages...
          var range = response.result;
          
          if (range.values.length > 0) 
          {
          
            // Clear text area...
            document.getElementById("chat_text").innerHTML ="";

            
            // Varible...
            var i;

            // Write everything...
            for (i = 0; i < range.values.length; i++) 
            {
              
              var row = range.values[i];
           
              if(row[0])
                row[0] = "[" + row[0] + "] ";

              if(row[1])
                row[1] = row[1] + ": ";

              // Write...              
              document.getElementById("chat_text").innerHTML += row[0] + row[1] + row[2] + "<br />";
            }
          } 
        }, function(response) {});

        // Reapeat this every 2 sec...
        setTimeout(
          function()
          {
           
            Update();
          }, 2000);
      }



      // Send Message...
      function Send()
      {

        // Get old one...
        gapi.client.sheets.spreadsheets.values.get({spreadsheetId: '1CcAqJT0d1mPRO5NoKcYT-30nfDYJkZYhUrtE0fm5vF4', range: roomID + '!A1:C',}).then(function(response)
        {
          
          // New message index...
          var index = response.result.values.length + 1;


          var values = [[ Time() , document.getElementById("name_field").value,  document.getElementById("message_field").value],];
          var body = {values: values};

          // Send new...
          gapi.client.sheets.spreadsheets.values.update({spreadsheetId: '1CcAqJT0d1mPRO5NoKcYT-30nfDYJkZYhUrtE0fm5vF4', range: roomID + '!A' + index + ':C', valueInputOption: 'RAW', resource: body}).then((response) => {var result = response.result;});
        }, 
        function(response) {});
      }



      // Change room...      
      function ChangeRoom(ID)
      {

        roomID = ID;
        document.getElementById("room_name").innerHTML = "Room #" + roomID;
      }

      // Return Time (HH:MM:SS)
      function Time()
      {

        var today = new Date();
        var time = "";


        // Hours...
        if(today.getHours() < 10)
          time += "0" + today.getHours();

        else
          time += today.getHours();


        // Minutes...
        if(today.getMinutes() < 10)
          time += ":0" + today.getMinutes();

        else
          time +=  ":" + today.getMinutes()


        // Seconds...
        if(today.getSeconds() < 10)
          time += ":0" + today.getSeconds();

        else 
          time += ":" + today.getSeconds();
        


        // RETURN!!!
        return time;
      }
    </script>

    
    <!-- THIS WAS HERE ALL THE TIME -->
    <script async defer src="https://apis.google.com/js/api.js"
    
      onload="this.onload=function(){};handleClientLoad()"
      onreadystatechange="if (this.readyState === 'complete') this.onload()">
    </script>
  </body>
</html>